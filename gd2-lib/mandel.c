#include "GD2.h"
#include <stdlib.h>
#include <math.h>
#include <stdint.h>

uint32_t addr_pal = 0xe1000UL;

uint8_t pal[1024] = {120, 156, 37, 211, 113, 76, 91, 85, 20, 199, 241, 235, 156, 105, 148, 100, 77, 156, 88, 22, 35, 173, 98, 172, 166, 97, 101, 67, 172, 201, 48, 15,
                     86, 180, 74, 227, 170, 45, 236, 45, 101, 179, 83, 28, 100, 84, 243, 64, 70, 42, 97, 218, 46, 4, 138, 140, 164, 102, 58, 187, 133, 104, 205, 22,
                     45, 110, 35, 221, 66, 182, 102, 225, 143, 178, 137, 3, 54, 99, 193, 100, 153, 66, 24, 91, 70, 196, 100, 226, 212, 68, 150, 232, 31, 95, 15, 154,
                     151, 207, 31, 47, 239, 222, 147, 251, 126, 231, 92, 128, 149, 149, 21, 150, 151, 151, 89, 92, 92, 100, 118, 118, 150, 153, 153, 25, 38, 39, 39, 201,
                     229, 114, 100, 179, 89, 50, 153, 12, 233, 116, 154, 84, 42, 69, 50, 153, 36, 145, 72, 16, 143, 199, 137, 70, 163, 68, 34, 17, 12, 195, 160, 185,
                     185, 153, 80, 40, 132, 174, 235, 248, 124, 62, 60, 30, 15, 154, 166, 225, 114, 185, 112, 58, 157, 216, 237, 118, 172, 86, 43, 22, 139, 5, 179, 217,
                     140, 201, 100, 66, 41, 37, 53, 144, 125, 200, 90, 228, 125, 213, 29, 177, 32, 242, 34, 39, 50, 34, 37, 18, 34, 42, 12, 17, 18, 30, 225, 98,
                     108, 14, 146, 87, 160, 227, 60, 212, 15, 193, 179, 73, 216, 208, 43, 117, 58, 196, 222, 95, 81, 175, 207, 163, 118, 76, 163, 124, 227, 168, 154, 179,
                     168, 231, 164, 214, 211, 253, 40, 219, 1, 84, 81, 39, 250, 220, 109, 220, 163, 215, 112, 14, 126, 131, 181, 43, 195, 250, 134, 65, 76, 238, 184, 172,
                     233, 144, 250, 245, 248, 36, 31, 57, 22, 230, 159, 110, 177, 110, 116, 138, 130, 193, 19, 220, 255, 94, 31, 166, 221, 173, 220, 247, 114, 144, 188, 124,
                     203, 136, 132, 104, 23, 7, 174, 223, 38, 118, 113, 154, 200, 215, 89, 118, 117, 127, 202, 16, 215, 249, 100, 113, 130, 216, 228, 48, 225, 225, 195, 236,
                     56, 180, 159, 154, 200, 91, 148, 5, 107, 121, 84, 219, 44, 245, 35, 120, 127, 111, 229, 197, 27, 123, 169, 158, 126, 131, 202, 177, 32, 174, 211, 126,
                     54, 127, 225, 165, 244, 35, 55, 79, 197, 42, 41, 105, 173, 160, 120, 119, 41, 27, 94, 125, 146, 135, 170, 138, 49, 151, 89, 120, 192, 102, 102, 173,
                     89, 50, 92, 125, 22, 68, 78, 164, 68, 84, 132, 132, 38, 74, 21, 75, 255, 100, 185, 114, 183, 137, 211, 127, 22, 146, 252, 161, 128, 216, 153, 123,
                     9, 127, 188, 134, 186, 246, 53, 104, 219, 239, 129, 191, 191, 135, 63, 190, 130, 37, 9, 236, 170, 14, 19, 242, 199, 231, 61, 240, 165, 139, 155, 253,
                     54, 206, 25, 69, 244, 6, 10, 217, 94, 177, 142, 178, 98, 19, 83, 51, 251, 24, 25, 217, 74, 95, 159, 69, 250, 38, 201, 44, 45, 193, 165, 75,
                     48, 60, 12, 3, 3, 18, 130, 164, 224, 247, 195, 166, 77, 80, 84, 244, 95, 83, 23, 196, 184, 56, 37, 14, 139, 152, 104, 18, 254, 213, 134, 103,
                     127, 132, 163, 19, 208, 34, 251, 107, 142, 192, 195, 81, 126, 83, 97, 166, 84, 3, 41, 245, 18, 109, 170, 156, 215, 212, 19, 92, 149, 185, 27, 149,
                     89, 75, 215, 213, 209, 93, 93, 205, 206, 141, 27, 217, 246, 248, 99, 112, 89, 66, 63, 33, 250, 69, 139, 168, 253, 191, 97, 243, 106, 158, 156, 204,
                     207, 49, 117, 140, 78, 213, 73, 189, 244, 178, 66, 85, 160, 126, 249, 150, 181, 151, 211, 20, 12, 13, 240, 224, 254, 183, 201, 71, 243, 100, 141, 44,
                     169, 80, 138, 184, 47, 142, 161, 25, 232, 78, 157, 42, 91, 21, 142, 66, 7, 55, 198, 97, 236, 168, 196, 209, 250, 23, 3, 250, 60, 251, 158, 159,
                     160, 233, 153, 51, 52, 56, 63, 227, 21, 123, 15, 115, 63, 35, 247, 4, 185, 27, 208, 211, 115, 147, 182, 182, 239, 104, 108, 188, 72, 32, 112, 86,
                     102, 58, 205, 136, 12, 200, 231, 23, 224, 96, 22, 186, 78, 222, 165, 253, 248, 29, 154, 147, 183, 104, 56, 120, 141, 64, 119, 30, 111, 87, 14, 79,
                     251, 8, 110, 227, 36, 90, 248, 56, 91, 26, 7, 113, 133, 18, 148, 235, 113, 156, 129, 40, 14, 95, 4, 187, 39, 76, 137, 59, 132, 85, 11, 240,
                     136, 203, 139, 197, 169, 177, 222, 81, 142, 185, 196, 65, 34, 157, 35, 118, 36, 67, 219, 135, 41, 246, 188, 127, 136, 224, 187, 189, 248, 91, 62, 160,
                     246, 205, 14, 182, 6, 223, 97, 75, 96, 15, 229, 222, 93, 148, 190, 160, 83, 82, 233, 101, 69, 218, 165, 73, 238, 182, 213, 236, 37, 168, 127, 1,
                     142, 232, 94, 65};

void setup()
{
    printf("\r\nInitialising GD\r\n");
    GD.begin(0);

    GD.ClearColorRGB(0x0);
    GD.Clear();

    GD.BitmapLayout(PALETTED8, GD.w, GD.h);
    GD.BitmapSize(NEAREST, BORDER, BORDER, GD.w, GD.h);
    GD.BitmapSource(0);
    GD.Begin(BITMAPS);
    GD.BlendFunc(ONE, ZERO);

    GD.ColorMask(0, 0, 0, 1);
    GD.PaletteSource(addr_pal + 3);
    GD.Vertex2f(0, 0);

    GD.ColorMask(1, 0, 0, 0);
    GD.PaletteSource(addr_pal + 2);
    GD.Vertex2f(0, 0);

    GD.ColorMask(0, 1, 0, 0);
    GD.PaletteSource(addr_pal + 1);
    GD.Vertex2f(0, 0);

    GD.ColorMask(0, 0, 1, 0);
    GD.PaletteSource(addr_pal + 0);
    GD.Vertex2f(0, 0);
    GD.swap();

    for (int i = 0; i < 836; i++)
    {
        GD.wr(addr_pal + i, pal[i]);
    }
}

static void plot(uint16_t x, uint16_t y, uint32_t i)
{
    if ((x < 1280) && (y < 720)) {
        GD.wr(x + (1280UL * y), i);
    }
        

}

#define MAXCOUNT 255


int main(void)
{
    //0.27085 0.27100 0.004640 0.004810
    const double xmin = (double).27085;
    const double xmax = (double).27100;
    const double ymin = (double).004640;
    const double ymax = (double).004810;

    const int xres = 1280;
    const int yres = 720; //(xres * (ymax - ymin)) / (xmax - xmin);
    const int maxiter = 255;

    setup();

    printf("\r\nDrawing\r\n");

    double dx = (xmax - xmin) / xres;
    double dy = (ymax - ymin) / yres;

    double x, y; /* Coordinates of the current point in the complex plane. */

    int i, j; /* Pixel counters */
    int k;    /* Iteration counter */
    for (j = 0; j < yres; j++)
    {
        y = ymax - j * dy;
        for (i = 0; i < xres; i++)
        {
            double u = (double)0.0;
            double v = (double)0.0;
            double u2 = 0.0;
            double v2 = 0.0;
            x = (double)xmin + i * dx;
            /* iterate the point */
            for (k = 1; k < maxiter && (u2 + v2 < (double)4.0); k++)
            {
                v = 2 * u * v + y;
                u = u2 - v2 + x;
                u2 = u * u;
                v2 = v * v;
            };

            /* compute  pixel color and write it to file */
            if (k < maxiter)
            {
                plot(i,j,k);
            };
        }
    }
}
 